<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Firebase Setup</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background: #000; color: #00ff00; font-family: monospace; padding: 20px; }
        .log { border: 1px solid #333; padding: 10px; height: 300px; overflow-y: auto; background: #050505; }
        button { background: #00ff00; color: #000; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <h2>Генератор структуры БД</h2>
    <p>Нажми кнопку, чтобы создать коллекции для своего аккаунта:</p>
    <button onclick="setupDatabase()">СОЗДАТЬ СТРУКТУРУ</button>
    
    <div class="log" id="log"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBUl6qHJRj8wI_L_1p9CETHpsjus99vVMg",
            authDomain: "majorinventory-df164.firebaseapp.com",
            projectId: "majorinventory-df164",
            storageBucket: "majorinventory-df164.firebasestorage.app",
            messagingSenderId: "603741122650",
            appId: "1:603741122650:web:35e730ab0448331eb3e863",
            measurementId: "G-7GS1M09F4T"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;

        function log(msg) {
            const l = document.getElementById('log');
            l.innerHTML += `> ${msg}<br>`;
        }

        async function setupDatabase() {
            // Определяем юзернейм
            const user = tg.initDataUnsafe?.user;
            const myUsername = (user?.username || `id${user?.id}` || "guest").toLowerCase();

            log(`Инициализация для пользователя: <b>${myUsername}</b>`);

            try {
                // 1. Создаем ссылку на коллекцию инвентаря
                const invRef = db.collection("users").doc(myUsername).collection("inventory");

                // 2. Добавляем тестовый предмет
                log("Добавление тестового NFT...");
                await invRef.add({
                    name: "Vintage Cigar",
                    image: "https://nft.fragment.com/gift/vintagecigar-7301.large.jpg",
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                log("<span style='color:white'>✅ УСПЕХ!</span>");
                log("Структура создана: users -> " + myUsername + " -> inventory -> item");
                log("Теперь можешь открывать inventory.html");

            } catch (e) {
                log("<span style='color:red'>❌ ОШИБКА:</span> " + e.message);
                console.error(e);
            }
        }
    </script>
</body>
</html>