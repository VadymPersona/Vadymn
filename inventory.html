<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: white; font-family: -apple-system, sans-serif; min-height: 100vh; margin: 0; padding: 20px; padding-bottom: 50px; overflow-x: hidden; }
        .inventory-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .nft-card { background: linear-gradient(145deg, #111 0%, #050505 100%); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 24px; padding: 12px; text-align: center; position: relative; animation: fadeIn 0.5s ease; }
        .nft-image { width: 100%; aspect-ratio: 1/1; border-radius: 20px; object-fit: cover; margin-bottom: 12px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-base { width: 100%; padding: 10px; border-radius: 12px; font-weight: 800; font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; transition: transform 0.1s; }
        .btn-base:active { transform: scale(0.95); }
        
        .withdraw-btn { background: #3b82f6; color: white; margin-bottom: 8px; }
        .raffle-btn { background: #eab308; color: black; }
        
        /* –ö–Ω–æ–ø–∫–∞-—Å–∞–º–æ–ª–µ—Ç–∏–∫ (–°—Å—ã–ª–∫–∞ –Ω–∞ NFT) */
        .tg-link-btn { position: absolute; top: 18px; right: 18px; width: 32px; height: 32px; background: #000; border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; z-index: 10; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .tg-link-btn svg { width: 16px; height: 16px; fill: white; }

        /* –ú–æ–¥–∞–ª–∫–∏ */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        .modal-card { background: linear-gradient(160deg, #1a1a1a 0%, #000 100%); border: 1px solid rgba(255, 255, 255, 0.1); padding: 24px; border-radius: 30px; text-align: center; width: 100%; max-width: 340px; }
        .input-dark { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 12px; width: 100%; padding: 12px; font-size: 14px; outline: none; }
        
        .status-badge { position: absolute; top: 18px; left: 18px; background: #3b82f6; padding: 4px 8px; border-radius: 8px; font-size: 9px; font-weight: 900; z-index: 10; }
        .nft-image.pending { filter: grayscale(1) opacity(0.4); }

        .tab-container { display: flex; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 4px; margin-bottom: 16px; }
        .tab-btn { flex: 1; padding: 8px; font-size: 10px; font-weight: 800; text-transform: uppercase; border-radius: 10px; color: #71717a; }
        .tab-btn.active { background: #eab308; color: black; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="flex items-center mb-8 gap-4">
        <button onclick="location.href='cases.html'" class="text-zinc-400 text-3xl p-2 active:scale-75 transition-transform">‚Üê</button>
        <div class="flex-1">
            <h1 class="text-2xl font-black italic tracking-tighter uppercase">INVENTORY</h1>
        </div>
        <div id="item-count" class="bg-zinc-900 px-3 py-1 rounded-full text-xs text-zinc-400 font-bold uppercase">0 Items</div>
    </div>

    <div id="inventory-list" class="inventory-grid">
        <div class="col-span-2 text-center py-20 text-zinc-600 font-bold text-sm animate-pulse" id="loader">–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –ë–ê–ó–ï...</div>
    </div>

    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-32">
        <h2 class="text-zinc-500 font-black uppercase tracking-[0.3em] text-2xl">–ü–£–°–¢–û</h2>
    </div>

    <div id="withdraw-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="text-4xl mb-4">üíé</div>
            <h2 class="text-xl font-black uppercase text-blue-500 mb-2">–í—ã–≤–æ–¥ NFT</h2>
            <p class="text-[10px] text-zinc-400 uppercase font-bold mb-6 italic">–°—Ä–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏: –¥–æ 21 –¥–Ω—è</p>
            <div class="bg-blue-600/10 border border-blue-500/20 p-4 rounded-2xl mb-6 text-left">
                <p class="text-[10px] text-zinc-300 leading-relaxed uppercase font-black">
                    –ö–æ–º–∏—Å—Å–∏—è —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞: <span class="text-yellow-400">30 ‚≠ê</span>. –û–ø–ª–∞—Ç–∏—Ç–µ —á–µ—Ä–µ–∑ Relayer.
                </p>
            </div>
            <button onclick="tg.openTelegramLink('https://t.me/personovich')" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl uppercase text-xs mb-3">–û–ø–ª–∞—Ç–∏—Ç—å 30 ‚≠ê</button>
            <button onclick="submitWithdraw()" class="w-full border border-blue-600 text-blue-500 font-black py-4 rounded-xl uppercase text-xs">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É</button>
            <button onclick="closeModal('withdraw-modal')" class="mt-4 text-zinc-600 uppercase text-[10px] font-bold">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="raffle-modal" class="modal-overlay">
        <div class="modal-card">
            <h2 class="text-lg font-black italic uppercase mb-4 text-yellow-500">–ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—É—Ä—Å–∞</h2>
            <img id="raffle-img" src="" class="w-20 h-20 rounded-2xl mx-auto mb-4 object-cover border border-white/10">
            <div class="tab-container">
                <button onclick="switchRaffleType('time')" id="tab-time" class="tab-btn active">–í—Ä–µ–º—è</button>
                <button onclick="switchRaffleType('users')" id="tab-users" class="tab-btn">–õ—é–¥–∏</button>
            </div>
            <input type="number" id="raffle-value" class="input-dark mb-4" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ (–º–∏–Ω/—á–µ–ª)">
            <input type="text" id="raffle-channel" class="input-dark mb-4" placeholder="@–∫–∞–Ω–∞–ª (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏)">
            <button onclick="createRaffle()" class="w-full bg-yellow-500 text-black font-black py-4 rounded-xl uppercase text-xs">–°–æ–∑–¥–∞—Ç—å</button>
            <button onclick="closeModal('raffle-modal')" class="mt-4 text-zinc-500 uppercase text-[10px] font-bold">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑
        const invConfig = { apiKey: "AIzaSyBUl6qHJRj8wI_L_1p9CETHpsjus99vVMg", projectId: "majorinventory-df164" };
        const raffleConfig = { apiKey: "AIzaSyB2PZq-Jxv9vkjj_AK_4gb1Bu69UYSHibo", projectId: "majorrandom-3bdb0" };

        const invApp = firebase.initializeApp(invConfig, "invApp");
        const raffleApp = firebase.initializeApp(raffleConfig, "raffleApp");
        const invDb = invApp.firestore();
        const raffleDb = raffleApp.firestore();

        const tg = window.Telegram.WebApp;
        const myUsername = (tg.initDataUnsafe?.user?.username || `id${tg.initDataUnsafe?.user?.id}`).toLowerCase();
        
        let currentItemData = null;
        let currentRaffleType = 'time';

        // –õ–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ t.me/nft/
        function getTgNftLink(imgUrl) {
            try {
                const slug = imgUrl.split('/gift/')[1].split('.large.jpg')[0]; // santahat-55045
                const parts = slug.split('-');
                const number = parts.pop();
                const name = parts.map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('');
                return `https://t.me/nft/${name}-${number}`;
            } catch(e) { return 'https://t.me/nft'; }
        }

        // –ó–ê–ì–†–£–ó–ö–ê –ü–†–ï–î–ú–ï–¢–û–í –ò–ó –ë–ê–ó–´ –ò–ù–í–ï–ù–¢–ê–†–Ø (invDb)
        function loadInventory() {
            invDb.collection("users").doc(myUsername).collection("inventory")
            .onSnapshot((snap) => {
                const list = document.getElementById('inventory-list');
                const loader = document.getElementById('loader');
                list.innerHTML = '';
                if (loader) loader.classList.add('hidden');
                
                document.getElementById('item-count').innerText = `${snap.size} ITEMS`;

                if (snap.empty) {
                    document.getElementById('empty-state').classList.remove('hidden');
                    return;
                }
                document.getElementById('empty-state').classList.add('hidden');

                snap.forEach((doc) => {
                    const item = doc.data();
                    const isPending = item.status === 'pending';
                    const nftUrl = getTgNftLink(item.image);
                    
                    const card = document.createElement('div');
                    card.className = 'nft-card';
                    card.innerHTML = `
                        ${isPending ? `<div class="status-badge">WAITING...</div>` : ''}
                        
                        <div class="tg-link-btn" onclick="tg.openLink('${nftUrl}')">
                            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.07-.2-.08-.06-.19-.04-.27-.02-.11.02-1.93 1.23-5.46 3.62-.51.35-.98.52-1.4.51-.46-.01-1.35-.26-2.01-.48-.81-.27-1.45-.41-1.39-.87.03-.24.36-.49.99-.75 3.87-1.68 6.45-2.79 7.74-3.33 3.68-1.54 4.44-1.81 4.94-1.82.11 0 .35.03.5.16.13.1.17.24.18.33.01.06.02.2.01.3z"/></svg>
                        </div>

                        <img src="${item.image}" class="nft-image ${isPending ? 'pending' : ''}">
                        <div class="text-[10px] text-zinc-400 font-bold uppercase truncate px-2 mb-3">${item.name}</div>
                        
                        ${!isPending ? `
                            <button onclick="openWithdrawModal('${doc.id}')" class="btn-base withdraw-btn">–í—ã–≤–µ—Å—Ç–∏</button>
                            <button onclick="openRaffleModal('${doc.id}', '${item.name}', '${item.image}')" class="btn-base raffle-btn">–†–∞–∑—ã–≥—Ä–∞—Ç—å</button>
                        ` : `
                            <div class="py-2 text-[8px] text-blue-500 font-black uppercase italic">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º</div>
                        `}
                    `;
                    list.appendChild(card);
                });
            }, (error) => {
                console.error("Firebase Error:", error);
                document.getElementById('loader').innerText = "–û–®–ò–ë–ö–ê –î–û–°–¢–£–ü–ê";
            });
        }

        // –ú–æ–¥–∞–ª–∫–∏
        function openWithdrawModal(id) {
            currentItemData = { id };
            document.getElementById('withdraw-modal').style.display = 'flex';
        }

        async function submitWithdraw() {
            try {
                await invDb.collection("users").doc(myUsername).collection("inventory").doc(currentItemData.id).update({
                    status: 'pending',
                    requestTime: firebase.firestore.FieldValue.serverTimestamp()
                });
                closeModal('withdraw-modal');
                tg.showAlert("–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! –ú—ã –ø—Ä–æ–≤–µ—Ä–∏–º –æ–ø–ª–∞—Ç—É 30 –∑–≤–µ–∑–¥ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è.");
            } catch(e) { tg.showAlert("–û—à–∏–±–∫–∞: " + e.message); }
        }

        function openRaffleModal(id, name, image) {
            currentItemData = { id, name, image };
            document.getElementById('raffle-img').src = image;
            document.getElementById('raffle-modal').style.display = 'flex';
        }

        async function createRaffle() {
            const val = document.getElementById('raffle-value').value;
            const chan = document.getElementById('raffle-channel').value;
            if (!val || val <= 0) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");

            tg.showConfirm("–°–æ–∑–¥–∞—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à? –ü—Ä–µ–¥–º–µ—Ç –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω –∏–∑ –≤–∞—à–µ–≥–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è.", async (ok) => {
                if (!ok) return;
                try {
                    await invDb.collection("users").doc(myUsername).collection("inventory").doc(currentItemData.id).delete();
                    await raffleDb.collection("global_raffles").add({
                        itemName: currentItemData.name,
                        itemImage: currentItemData.image,
                        organizer: myUsername,
                        targetValue: parseInt(val),
                        raffleType: currentRaffleType,
                        userChannel: chan || null,
                        status: "active",
                        participants: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    closeModal('raffle-modal');
                    tg.showPopup({ title: "–£—Å–ø–µ—Ö", message: "–†–æ–∑—ã–≥—Ä—ã—à –∑–∞–ø—É—â–µ–Ω!" });
                } catch(e) { tg.showAlert(e.message); }
            });
        }

        function switchRaffleType(type) {
            currentRaffleType = type;
            document.getElementById('tab-time').classList.toggle('active', type === 'time');
            document.getElementById('tab-users').classList.toggle('active', type === 'users');
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        tg.ready();
        tg.expand();
        loadInventory();
    </script>
</body>
</html>