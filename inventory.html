<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: white; font-family: -apple-system, sans-serif; min-height: 100vh; margin: 0; padding: 20px; overflow-x: hidden; padding-bottom: 50px; }
        .inventory-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .nft-card { background: linear-gradient(145deg, #111 0%, #050505 100%); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 24px; padding: 12px; text-align: center; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); animation: fadeIn 0.5s ease forwards; position: relative; }
        .nft-image { width: 100%; aspect-ratio: 1/1; border-radius: 20px; object-fit: cover; margin-bottom: 12px; border: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; }
        .btn-base { width: 100%; padding: 10px; border-radius: 12px; font-weight: 800; font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; transition: transform 0.1s; }
        .btn-base:active { transform: scale(0.95); }
        .withdraw-btn { background: #3b82f6; color: white; margin-bottom: 8px; }
        .raffle-btn { background: #eab308; color: black; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        .modal-card { background: linear-gradient(160deg, #1a1a1a 0%, #000 100%); border: 1px solid rgba(255, 255, 255, 0.1); padding: 24px; border-radius: 30px; text-align: center; width: 100%; max-width: 340px; }
        .input-dark { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 12px; width: 100%; padding: 12px; font-size: 14px; outline: none; }
        .tab-container { display: flex; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 4px; margin-bottom: 16px; }
        .tab-btn { flex: 1; padding: 8px; font-size: 10px; font-weight: 800; text-transform: uppercase; border-radius: 10px; color: #71717a; }
        .tab-btn.active { background: #eab308; color: black; }

        /* –≠—Ñ—Ñ–µ–∫—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–≤–æ–¥–∞ */
        .withdraw-timer { position: absolute; top: 18px; left: 18px; background: rgba(59, 130, 246, 0.9); padding: 4px 8px; border-radius: 10px; font-size: 10px; font-weight: 900; color: white; display: flex; align-items: center; gap: 4px; z-index: 5; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .nft-image.pending { filter: grayscale(0.5) opacity(0.8); cursor: default; }
    </style>
</head>
<body>

    <div class="flex items-center mb-8 gap-4">
        <button onclick="location.href='cases.html'" class="text-zinc-400 text-3xl p-2 active:scale-75 transition-transform leading-none">‚Üê</button>
        <div class="flex-1">
            <h1 class="text-2xl font-black italic tracking-tighter uppercase">INVENTORY</h1>
        </div>
        <div id="item-count" class="bg-zinc-900 px-3 py-1 rounded-full text-xs text-zinc-400 font-bold whitespace-nowrap uppercase">0 Items</div>
    </div>

    <div id="inventory-list" class="inventory-grid">
        <div class="col-span-2 text-center py-20 text-zinc-600 font-bold text-sm animate-pulse" id="loader">–ó–ê–ì–†–£–ó–ö–ê...</div>
    </div>

    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-32">
        <h2 class="text-zinc-500 font-black uppercase tracking-[0.3em] text-2xl">–ü–£–°–¢–û</h2>
    </div>

    <div id="raffle-modal" class="modal-overlay">
        <div class="modal-card">
            <h2 class="text-lg font-black italic uppercase mb-4 text-yellow-500">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–∞</h2>
            <img id="raffle-img" src="" class="w-16 h-16 rounded-xl mx-auto mb-2 object-cover">
            <p id="raffle-name" class="text-xs font-bold uppercase text-zinc-300 mb-4"></p>

            <div class="tab-container">
                <button onclick="switchRaffleType('time')" id="tab-time" class="tab-btn active">–ù–∞ –í—Ä–µ–º—è</button>
                <button onclick="switchRaffleType('users')" id="tab-users" class="tab-btn">–£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
            </div>

            <input type="number" id="raffle-value" class="input-dark mb-4" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ">
            <input type="text" id="raffle-channel" class="input-dark mb-4" placeholder="@–≤–∞—à_–∫–∞–Ω–∞–ª (–æ–ø—Ü)">

            <button onclick="createRaffle()" class="w-full bg-yellow-500 text-black font-black py-3 rounded-xl uppercase text-xs">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
            <button onclick="closeModal('raffle-modal')" class="mt-4 text-zinc-500 uppercase text-[10px] font-bold">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="withdraw-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="text-3xl mb-4">üì¶</div>
            <h2 class="text-lg font-black uppercase text-blue-500 mb-2">–í—ã–≤–æ–¥ –ø—Ä–µ–¥–º–µ—Ç–∞</h2>
            <p class="text-zinc-400 text-[10px] mb-6 uppercase font-black">–í—ã–≤–æ–¥ –∑–∞–π–º–µ—Ç –æ—Ç 1 –¥–æ 21 –¥–Ω—è</p>
            <div class="bg-blue-500/10 border border-blue-500/20 p-4 rounded-2xl mb-6 text-left">
                <p class="text-[11px] text-zinc-300 leading-relaxed uppercase font-bold">
                    –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã —Å–∫–∏–Ω—É–ª–∏ <span class="text-yellow-400">30 ‚≠ê</span> –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É –ø–æ–¥–∞—Ä–∫–∞ –Ω–∞—à–µ–º—É Relayer!
                </p>
            </div>
            <button onclick="tg.openTelegramLink('https://t.me/personovich')" class="w-full bg-blue-600 text-white font-black py-3 rounded-xl uppercase text-xs mb-3">–°–∫–∏–Ω—É—Ç—å 30 ‚≠ê</button>
            <button onclick="submitWithdraw()" class="w-full border border-blue-600 text-blue-500 font-black py-3 rounded-xl uppercase text-xs">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã–≤–æ–¥</button>
            <button onclick="closeModal('withdraw-modal')" class="mt-4 text-zinc-600 uppercase text-[9px] font-bold">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        const invConfig = { apiKey: "AIzaSyBUl6qHJRj8wI_L_1p9CETHpsjus99vVMg", projectId: "majorinventory-df164" };
        const raffleConfig = { apiKey: "AIzaSyB2PZq-Jxv9vkjj_AK_4gb1Bu69UYSHibo", projectId: "majorrandom-3bdb0" };

        const invApp = firebase.initializeApp(invConfig, "invApp");
        const raffleApp = firebase.initializeApp(raffleConfig, "raffleApp");
        const invDb = invApp.firestore();
        const raffleDb = raffleApp.firestore();

        const tg = window.Telegram.WebApp;
        const myUsername = (tg.initDataUnsafe?.user?.username || `id${tg.initDataUnsafe?.user?.id}`).toLowerCase();

        let currentItemData = null;
        let currentRaffleType = 'time';

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—Å—ã–ª–∫–∏ Fragment (–°–¥–µ–ª–∞–µ—Ç SantaHat –∏–∑ santahat)
        function getFragmentData(imageUrl) {
            try {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º "santahat-55045" –∏–∑ URL
                const slug = imageUrl.split('/gift/')[1].split('.large.jpg')[0]; 
                const parts = slug.split('-');
                const number = parts.pop(); // –î–æ—Å—Ç–∞–µ–º 55045
                
                // –î–µ–ª–∞–µ–º –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ —Å –±–æ–ª—å—à–æ–π –±—É–∫–≤—ã
                const formattedName = parts.map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('');
                
                return {
                    link: `https://t.me/nft/${formattedName}-${number}`,
                    number: `#${number}`,
                    fullName: `${formattedName} #${number}`
                };
            } catch (e) {
                return { link: 'https://t.me/nft', number: '#0000', fullName: 'NFT Item' };
            }
        }

        function loadInventory() {
            invDb.collection("users").doc(myUsername).collection("inventory")
            .onSnapshot((snap) => {
                const list = document.getElementById('inventory-list');
                list.innerHTML = '';
                document.getElementById('item-count').innerText = `${snap.size} ITEMS`;
                document.getElementById('loader').classList.add('hidden');
                
                if (snap.empty) {
                    document.getElementById('empty-state').classList.remove('hidden');
                    return;
                }
                document.getElementById('empty-state').classList.add('hidden');

                snap.forEach((doc) => {
                    const item = doc.data();
                    const isPending = item.status === 'pending';
                    const nftData = getFragmentData(item.image);

                    const card = document.createElement('div');
                    card.className = 'nft-card';
                    card.innerHTML = `
                        ${isPending ? `<div class="withdraw-timer">‚è±Ô∏è 21–¥</div>` : ''}
                        
                        <img src="${item.image}" class="nft-image ${isPending ? 'pending' : ''}" 
                             onclick="if(!${isPending}) { tg.openLink('${nftData.link}') }">
                        
                        <div class="px-2">
                            <div class="text-[10px] text-zinc-400 font-bold uppercase truncate">${item.name}</div>
                            <div class="text-[9px] text-yellow-500 font-black mt-0.5">${nftData.number}</div>
                        </div>
                        
                        <div class="mt-3">
                        ${!isPending ? `
                            <button onclick="openWithdrawModal('${doc.id}')" class="btn-base withdraw-btn">–í—ã–≤–µ—Å—Ç–∏</button>
                            <button onclick="openRaffleModal('${doc.id}', '${nftData.fullName}', '${item.image}')" class="btn-base raffle-btn">–†–∞–∑—ã–≥—Ä–∞—Ç—å</button>
                        ` : `
                            <div class="text-[8px] text-zinc-600 font-black uppercase italic py-2">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</div>
                        `}
                        </div>
                    `;
                    list.appendChild(card);
                });
            });
        }

        function openWithdrawModal(id) {
            currentItemData = { id };
            document.getElementById('withdraw-modal').style.display = 'flex';
        }

        async function submitWithdraw() {
            try {
                await invDb.collection("users").doc(myUsername).collection("inventory").doc(currentItemData.id).update({
                    status: 'pending',
                    requestDate: firebase.firestore.FieldValue.serverTimestamp()
                });
                closeModal('withdraw-modal');
                tg.showPopup({ title: "–£—Å–ø–µ—Ö", message: "–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!" });
            } catch (e) { tg.showAlert(e.message); }
        }

        function openRaffleModal(id, name, image) {
            currentItemData = { id, name, image };
            document.getElementById('raffle-img').src = image;
            document.getElementById('raffle-name').innerText = name;
            document.getElementById('raffle-modal').style.display = 'flex';
        }

        async function createRaffle() {
            const val = document.getElementById('raffle-value').value;
            const chan = document.getElementById('raffle-channel').value;
            if (!val || val <= 0) return tg.showAlert("–£–∫–∞–∂–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ!");

            tg.showConfirm("–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à?", async (ok) => {
                if (!ok) return;
                try {
                    await invDb.collection("users").doc(myUsername).collection("inventory").doc(currentItemData.id).delete();
                    await raffleDb.collection("global_raffles").add({
                        itemName: currentItemData.name,
                        itemImage: currentItemData.image,
                        organizer: myUsername,
                        targetValue: parseInt(val),
                        raffleType: currentRaffleType,
                        userChannel: chan || null,
                        participants: [],
                        status: "active",
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    closeModal('raffle-modal');
                } catch (e) { tg.showAlert(e.message); }
            });
        }

        function switchRaffleType(type) {
            currentRaffleType = type;
            document.getElementById('tab-time').classList.toggle('active', type === 'time');
            document.getElementById('tab-users').classList.toggle('active', type === 'users');
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        tg.ready();
        tg.expand();
        loadInventory();
    </script>
</body>
</html>