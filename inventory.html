<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Инвентарь</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Стили из вашего исходного кода для сохранения дизайна */
        body { background-color: #000; color: white; font-family: -apple-system, sans-serif; min-height: 100vh; margin: 0; padding: 20px; overflow-x: hidden; padding-bottom: 50px; }
        .inventory-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .nft-card { background: linear-gradient(145deg, #111 0%, #050505 100%); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 24px; padding: 12px; text-align: center; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); animation: fadeIn 0.5s ease forwards; position: relative; }
        .nft-image { width: 100%; aspect-ratio: 1/1; border-radius: 20px; object-fit: cover; margin-bottom: 12px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-base { width: 100%; padding: 10px; border-radius: 12px; font-weight: 800; font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; transition: transform 0.1s; }
        .btn-base:active { transform: scale(0.95); }
        .withdraw-btn { background: #3b82f6; color: white; margin-bottom: 8px; }
        .raffle-btn { background: #eab308; color: black; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        .modal-card { background: linear-gradient(160deg, #1a1a1a 0%, #000 100%); border: 1px solid rgba(255, 255, 255, 0.1); padding: 24px; border-radius: 30px; text-align: center; width: 100%; max-width: 340px; }
        .input-dark { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 12px; width: 100%; padding: 12px; font-size: 14px; outline: none; }
        .tab-container { display: flex; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 4px; margin-bottom: 16px; }
        .tab-btn { flex: 1; padding: 8px; font-size: 10px; font-weight: 800; text-transform: uppercase; border-radius: 10px; color: #71717a; }
        .tab-btn.active { background: #eab308; color: black; }
    </style>
</head>
<body>

    <div class="flex items-center mb-8 gap-4">
        <button onclick="location.href='cases.html'" class="text-zinc-400 text-3xl p-2 active:scale-75 transition-transform leading-none">←</button>
        <div class="flex-1">
            <h1 class="text-2xl font-black italic tracking-tighter uppercase">INVENTORY</h1>
        </div>
        <div id="item-count" class="bg-zinc-900 px-3 py-1 rounded-full text-xs text-zinc-400 font-bold whitespace-nowrap uppercase">0 Items</div>
    </div>

    <div id="inventory-list" class="inventory-grid">
        <div class="col-span-2 text-center py-20 text-zinc-600 font-bold text-sm animate-pulse" id="loader">ЗАГРУЗКА...</div>
    </div>

    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-32">
        <h2 class="text-zinc-500 font-black uppercase tracking-[0.3em] text-2xl">ПУСТО</h2>
    </div>

    <div id="raffle-modal" class="modal-overlay">
        <div class="modal-card">
            <h2 class="text-lg font-black italic uppercase mb-4 text-yellow-500">Настройка розыгрыша</h2>
            <img id="raffle-img" src="" class="w-16 h-16 rounded-xl mx-auto mb-2 object-cover">
            <p id="raffle-name" class="text-xs font-bold uppercase text-zinc-300 mb-4"></p>

            <div class="tab-container">
                <button onclick="switchRaffleType('time')" id="tab-time" class="tab-btn active">На Время</button>
                <button onclick="switchRaffleType('users')" id="tab-users" class="tab-btn">Участники</button>
            </div>

            <input type="number" id="raffle-value" class="input-dark mb-4" placeholder="Кол-во">
            <input type="text" id="raffle-channel" class="input-dark mb-4" placeholder="@ваш_канал (опц)">

            <button onclick="createRaffle()" class="w-full bg-yellow-500 text-black font-black py-3 rounded-xl uppercase text-xs">Запустить</button>
            <button onclick="closeModal('raffle-modal')" class="mt-4 text-zinc-500 uppercase text-[10px] font-bold">Отмена</button>
        </div>
    </div>

    <script>
        // 1. КОНФИГУРАЦИЯ ДВУХ БАЗ ДАННЫХ
        const invConfig = {
            apiKey: "AIzaSyBUl6qHJRj8wI_L_1p9CETHpsjus99vVMg",
            authDomain: "majorinventory-df164.firebaseapp.com",
            projectId: "majorinventory-df164",
            storageBucket: "majorinventory-df164.firebasestorage.app",
            messagingSenderId: "603741122650",
            appId: "1:603741122650:web:35e730ab0448331eb3e863"
        };

        const raffleConfig = {
            apiKey: "AIzaSyB2PZq-Jxv9vkjj_AK_4gb1Bu69UYSHibo",
            authDomain: "majorrandom-3bdb0.firebaseapp.com",
            projectId: "majorrandom-3bdb0",
            storageBucket: "majorrandom-3bdb0.firebasestorage.app",
            messagingSenderId: "45034652074",
            appId: "1:45034652074:web:540a4af61ab7f4effa2bd3"
        };

        // Инициализация приложений
        const invApp = firebase.initializeApp(invConfig, "invApp");
        const raffleApp = firebase.initializeApp(raffleConfig, "raffleApp");

        const invDb = invApp.firestore();
        const raffleDb = raffleApp.firestore();

        const tg = window.Telegram.WebApp;
        const user = tg.initDataUnsafe?.user;
        const myUsername = (user?.username || `id${user?.id}` || "guest").toLowerCase();

        let currentItemData = null; // Для хранения данных выбранного предмета

        // Загрузка инвентаря из ПЕРВОЙ базы
        function loadInventory() {
            invDb.collection("users").doc(myUsername).collection("inventory")
            .onSnapshot((querySnapshot) => {
                const list = document.getElementById('inventory-list');
                list.innerHTML = '';
                document.getElementById('item-count').innerText = `${querySnapshot.size} ITEMS`;
                
                if (querySnapshot.empty) {
                    document.getElementById('empty-state').classList.remove('hidden');
                    return;
                }
                document.getElementById('empty-state').classList.add('hidden');

                querySnapshot.forEach((doc) => {
                    const item = doc.data();
                    const card = document.createElement('div');
                    card.className = 'nft-card';
                    card.innerHTML = `
                        <img src="${item.image}" class="nft-image">
                        <div class="text-[10px] text-zinc-400 font-bold mb-3 uppercase">${item.name}</div>
                        <button onclick="openRaffleModal('${doc.id}', '${item.name}', '${item.image}')" class="btn-base raffle-btn">Разыграть</button>
                    `;
                    list.appendChild(card);
                });
            });
        }

        function openRaffleModal(id, name, image) {
            currentItemData = { id, name, image };
            document.getElementById('raffle-img').src = image;
            document.getElementById('raffle-name').innerText = name;
            document.getElementById('raffle-modal').style.display = 'flex';
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // СОЗДАНИЕ КОНКУРСА (Работа с двумя БД)
        async function createRaffle() {
            const val = document.getElementById('raffle-value').value;
            const chan = document.getElementById('raffle-channel').value;

            if (!val || val <= 0) return tg.showAlert("Укажите значение!");

            tg.showConfirm("Вы уверены? Предмет будет передан в систему конкурсов.", async (ok) => {
                if (!ok) return;

                try {
                    // ЭТАП 1: Удаление из базы ИНВЕНТАРЯ
                    await invDb.collection("users").doc(myUsername).collection("inventory").doc(currentItemData.id).delete();

                    // ЭТАП 2: Создание в базе КОНКУРСОВ
                    await raffleDb.collection("global_raffles").add({
                        itemName: currentItemData.name,
                        itemImage: currentItemData.image,
                        organizer: myUsername,
                        targetValue: parseInt(val),
                        raffleType: currentRaffleType, // 'time' или 'users'
                        userChannel: chan || null,
                        participants: [],
                        status: "active",
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    closeModal('raffle-modal');
                    tg.showPopup({ title: "Успех!", message: "Конкурс запущен. Предмет передан @personovich (холд)." });
                } catch (e) {
                    tg.showAlert("Ошибка: " + e.message);
                }
            });
        }

        function switchRaffleType(type) {
            currentRaffleType = type;
            document.getElementById('tab-time').classList.toggle('active', type === 'time');
            document.getElementById('tab-users').classList.toggle('active', type === 'users');
        }

        tg.ready();
        loadInventory();
    </script>
</body>
</html>