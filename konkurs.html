<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Major Конкурсы</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: white; font-family: -apple-system, sans-serif; padding-bottom: 120px; }
        
        .raffle-card {
            background: linear-gradient(145deg, #151515 0%, #050505 100%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 32px;
            padding: 20px;
        }

        .nft-preview {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 24px;
            object-fit: cover;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn-yellow {
            background: #eab308;
            color: black;
            font-weight: 800;
            transition: all 0.2s;
        }
        .btn-yellow:active { transform: scale(0.96); opacity: 0.9; }
        
        .btn-cancel {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .progress-bar {
            height: 6px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #eab308;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body class="p-5">

    <div class="flex items-center mb-8 gap-4">
        <button onclick="location.href='cases.html'" class="text-zinc-400 text-3xl">←</button>
        <h1 class="text-2xl font-black italic tracking-tighter uppercase">Live Конкурсы</h1>
    </div>

    <div id="raffles-list" class="space-y-6">
        <div class="text-center py-20 text-zinc-600 font-bold animate-pulse uppercase text-xs">Загрузка активных розыгрышей...</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBUl6qHJRj8wI_L_1p9CETHpsjus99vVMg",
            authDomain: "majorinventory-df164.firebaseapp.com",
            projectId: "majorinventory-df164",
            storageBucket: "majorinventory-df164.firebasestorage.app",
            messagingSenderId: "603741122650",
            appId: "1:603741122650:web:35e730ab0448331eb3e863"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;
        const user = tg.initDataUnsafe?.user;
        const myUsername = (user?.username || `id${user?.id}` || "guest").toLowerCase();

        function loadRaffles() {
            // Слушаем коллекцию глобальных розыгрышей
            db.collection("global_raffles").onSnapshot((snapshot) => {
                const list = document.getElementById('raffles-list');
                list.innerHTML = '';

                if (snapshot.empty) {
                    list.innerHTML = '<div class="text-center py-10 text-zinc-500 font-bold uppercase text-[10px]">Нет активных конкурсов</div>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const raffleId = doc.id;
                    const participantsCount = data.participants ? data.participants.length : 0;
                    const isOrganizer = data.organizer === myUsername;
                    const hasJoined = data.participants && data.participants.includes(myUsername);

                    const card = document.createElement('div');
                    card.className = 'raffle-card';
                    card.innerHTML = `
                        <img src="${data.itemImage}" class="nft-preview mb-4">
                        
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-black uppercase text-sm">${data.itemName}</h3>
                                <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-wider">Орг: @${data.organizer}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-green-400 font-black text-xs">FREE</span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="flex justify-between text-[10px] font-bold uppercase mb-1 text-zinc-400">
                                <span>Участники</span>
                                <span>${participantsCount} / ${data.targetValue}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${(participantsCount / data.targetValue) * 100}%"></div>
                            </div>
                        </div>

                        ${isOrganizer ? 
                            `<button onclick="cancelRaffle('${raffleId}', '${data.organizer}')" class="w-full py-3 rounded-2xl btn-cancel font-bold text-xs uppercase">Отменить конкурс</button>` :
                            `<button onclick="joinRaffle('${raffleId}')" ${hasJoined ? 'disabled' : ''} class="w-full py-4 rounded-2xl btn-yellow font-black text-xs uppercase shadow-lg shadow-yellow-500/10">
                                ${hasJoined ? 'Вы участвуете' : 'Участвовать'}
                            </button>`
                        }
                    `;
                    list.appendChild(card);
                });
            });
        }

        async function joinRaffle(raffleId) {
            tg.HapticFeedback.impactOccurred('medium');
            try {
                const ref = db.collection("global_raffles").doc(raffleId);
                const doc = await ref.get();
                const data = doc.data();

                // Проверка подписки (визуальная имитация)
                tg.showPopup({
                    title: 'Проверка подписки',
                    message: `Для участия необходимо быть подписанным на @major_bit ${data.userChannel ? 'и ' + data.userChannel : ''}`,
                    buttons: [{type: 'ok', text: 'Я подписался'}]
                }, async () => {
                    await ref.update({
                        participants: firebase.firestore.FieldValue.arrayUnion(myUsername)
                    });
                    
                    // Если набралось нужное кол-во, выбираем победителя
                    if (data.participants.length + 1 >= data.targetValue) {
                        finalizeRaffle(raffleId, [...data.participants, myUsername]);
                    }
                });
            } catch (e) { console.error(e); }
        }

        async function finalizeRaffle(raffleId, participants) {
            const winner = participants[Math.floor(Math.random() * participants.length)];
            const raffleRef = db.collection("global_raffles").doc(raffleId);
            const data = (await raffleRef.get()).data();

            // 1. Отправляем победителю
            await db.collection("users").doc(winner).collection("inventory").add({
                name: data.itemName,
                image: data.itemImage,
                wonFrom: data.organizer,
                date: firebase.firestore.FieldValue.serverTimestamp()
            });

            // 2. Удаляем розыгрыш
            await raffleRef.delete();

            tg.showPopup({
                title: 'Конкурс завершен!',
                message: `Победитель: @${winner}. Предмет отправлен в инвентарь.`
            });
        }

        async function cancelRaffle(raffleId, organizer) {
            tg.HapticFeedback.notificationOccurred('warning');
            const raffleRef = db.collection("global_raffles").doc(raffleId);
            const data = (await raffleRef.get()).data();

            // Возврат предмета владельцу
            await db.collection("users").doc(organizer).collection("inventory").add({
                name: data.itemName,
                image: data.itemImage,
                status: "returned"
            });

            await raffleRef.delete();
            tg.showAlert("Конкурс отменен. Предмет возвращен в ваш инвентарь.");
        }

        tg.ready();
        tg.expand();
        loadRaffles();
    </script>
</body>
</html>