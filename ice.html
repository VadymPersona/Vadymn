<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ice Arena Global</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: white; font-family: -apple-system, sans-serif; overflow: hidden; height: 100vh; }
        .card-grad { background: linear-gradient(145deg, #111 0%, #050505 100%); border: 1px solid rgba(255,255,255,0.08); border-radius: 30px; }
        #arena-container { position: relative; width: 100%; aspect-ratio: 1/1; border-radius: 40px; overflow: hidden; background: #050505; border: 2px solid rgba(255,255,255,0.1); }
        #zones-canvas { position: absolute; inset: 0; width: 100%; height: 100%; }
        #ball { position: absolute; width: 18px; height: 18px; background: #fff; border-radius: 50%; box-shadow: 0 0 20px #fff; z-index: 50; display: none; }
        .arena-logo { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 5; pointer-events: none; opacity: 0.15; }
        .arena-logo h2 { font-size: 3rem; font-weight: 900; font-style: italic; text-transform: uppercase; color: white; border: 4px solid white; padding: 10px 20px; }
        #big-win-toast { position: absolute; top: 12px; right: 12px; z-index: 100; background: rgba(20, 20, 20, 0.9); border: 1px solid rgba(255, 215, 0, 0.4); padding: 6px 12px; border-radius: 16px; display: none; align-items: center; gap: 8px; box-shadow: 0 0 20px rgba(255, 215, 0, 0.2); }
        .player-badge { display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 14px; background: rgba(255,255,255,0.03); font-size: 10px; font-weight: 700; border: 1px solid rgba(255,255,255,0.1); }
        #win-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(15px); z-index: 200; align-items: center; justify-content: center; }
        .btn-deposit { background: linear-gradient(90deg, #1d4ed8 0%, #3b82f6 100%); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        
        /* –°—Ç–µ–∫ –∏–∫–æ–Ω–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤ */
        .gift-stack { display: flex; align-items: center; margin-left: 4px; }
        .gift-fragment { width: 18px; height: 18px; border-radius: 50%; border: 1px solid #000; object-fit: cover; margin-left: -6px; box-shadow: 0 0 5px rgba(0,0,0,0.5); background: #111; }
        .gift-fragment:first-child { margin-left: 0; }
    </style>
</head>
<body class="p-6">

    <div id="big-win-toast">
        <img id="bw-avatar" src="" class="w-9 h-9 rounded-full border-2 border-yellow-500">
        <div>
            <div class="text-[8px] text-yellow-500 font-black uppercase leading-none mb-1">Record Win!</div>
            <div id="bw-info" class="text-[10px] font-bold text-white leading-tight">Name ‚Ä¢ 0 MJ</div>
        </div>
    </div>

    <div class="flex items-center mb-6 gap-4">
        <button onclick="location.href='cases.html'" class="text-zinc-400 text-2xl p-2 active:scale-75 transition-transform">‚Üê</button>
        <div class="timer-box bg-zinc-900/50 p-3 rounded-2xl border border-white/5 text-center min-w-[100px]">
            <span id="round-num" class="text-blue-500 text-[10px] uppercase font-black block">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            <div id="timer-val" class="text-xl font-black italic tabular-nums">00:20</div>
        </div>
    </div>

    <div id="arena-container" class="mb-4">
        <canvas id="zones-canvas"></canvas>
        <div class="arena-logo"><h2>Ice Arena</h2></div>
        <div id="ball"></div>
    </div>

    <div class="flex justify-between items-center mb-4 px-2">
        <div><span class="text-zinc-500 text-[9px] uppercase font-bold block">–ë–∞–Ω–∫</span><span id="total-bank" class="text-white font-black text-2xl">0</span></div>
        <div class="text-right"><span class="text-zinc-500 text-[9px] uppercase font-bold block">–®–∞–Ω—Å</span><span id="my-chance" class="text-blue-500 font-black text-2xl">0%</span></div>
    </div>

    <div id="players-list" class="flex flex-wrap gap-2 mb-4 overflow-y-auto max-h-[100px]"></div>

    <button onclick="location.href='deposit.html'" class="btn-deposit w-full py-4 mb-4 rounded-2xl font-black text-xs uppercase tracking-widest active:scale-95 transition-all flex items-center justify-center gap-2">
        <span>üéÅ</span> –î–µ–ø–æ–∑–∏—Ç –≥–∏—Ñ—Ç–∞–º–∏ <span>üéÅ</span>
    </button>

    <div class="card-grad p-4">
        <div class="grid grid-cols-3 gap-2">
            <button onclick="handleBet(100)" class="bet-btn bg-zinc-900 border border-white/5 py-4 rounded-xl font-black text-zinc-300 active:scale-95 transition-all text-xs">100</button>
            <button onclick="handleBet(250)" class="bet-btn bg-zinc-900 border border-white/5 py-4 rounded-xl font-black text-zinc-300 active:scale-95 transition-all text-xs">250</button>
            <button onclick="handleBet(500)" class="bet-btn bg-zinc-900 border border-white/5 py-4 rounded-xl font-black text-zinc-300 active:scale-95 transition-all text-xs">500</button>
        </div>
    </div>

    <div id="win-modal">
        <div class="card-grad p-10 text-center w-[85%] border-blue-500/30">
            <div class="text-blue-500 text-[10px] font-black uppercase mb-4">Winner</div>
            <img id="win-avatar" src="" class="w-20 h-20 rounded-full border-4 mx-auto mb-4 border-white/10">
            <div id="win-name" class="text-xl font-bold mb-1">Username</div>
            <div id="win-prize" class="text-3xl font-black text-blue-500">0 MJ</div>
        </div>
    </div>

    <script>
        const arenaConfig = {
            apiKey: "AIzaSyC48y52WCHeVqF8GB_YXHY-xGyCH3frhHU",
            authDomain: "majorcrypto-28e9a.firebaseapp.com",
            projectId: "majorcrypto-28e9a",
            storageBucket: "majorcrypto-28e9a.firebasestorage.app",
            appId: "1:16272287356:web:2b5c9bafc7bfd85ef60bf9"
        };
        const inventoryConfig = {
            apiKey: "AIzaSyBUl6qHJRj8wI_L_1p9CETHpsjus99vVMg",
            authDomain: "majorinventory-df164.firebaseapp.com",
            projectId: "majorinventory-df164",
            storageBucket: "majorinventory-df164.firebasestorage.app",
            appId: "1:603741122650:web:35e730ab0448331eb3e863"
        };

        const arenaApp = firebase.initializeApp(arenaConfig, "arena");
        const inventoryApp = firebase.initializeApp(inventoryConfig, "inventory");

        const db = arenaApp.firestore();
        const dbInv = inventoryApp.firestore();

        const tg = window.Telegram.WebApp;
        const user = tg.initDataUnsafe?.user;
        const myUsername = (user?.username || `id${user?.id}` || "guest").toLowerCase();
        
        const arenaRef = db.collection("ice_arena").doc("current_session");
        const betsRef = db.collection("ice_arena_bets");

        let playersData = {};
        let isSpinning = false;
        let isProcessed = false; 
        let imgObjects = {};
        let timerInterval = null;
        const palette = ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899', '#06B6D4', '#F97316'];

        function getColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return palette[Math.abs(hash) % palette.length];
        }

        const canvas = document.getElementById('zones-canvas');
        const ctx = canvas.getContext('2d');
        function resize() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; draw(); }
        window.addEventListener('resize', resize);
        resize();

        async function handleBet(amount) {
            if (isSpinning) return;
            const uRef = db.collection("users").doc(myUsername);
            const snap = await uRef.get();
            if (!snap.exists || snap.data().balance < amount) return tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ MJ!");

            await uRef.update({ balance: firebase.firestore.FieldValue.increment(-amount) });
            
            const aSnap = await arenaRef.get();
            if (!aSnap.exists) {
                const hist = await db.collection("ice_arena_history").get();
                await arenaRef.set({ endTime: Date.now() + 20000, round: hist.size + 1, winner: null, active: false });
            }
            
            await betsRef.doc(myUsername).set({
                username: myUsername, displayName: user?.first_name || myUsername,
                photo: user?.photo_url || `https://t.me/i/userpic/320/${myUsername}.jpg`,
                amount: firebase.firestore.FieldValue.increment(amount),
                isNft: false,
                stakedItems: []
            }, {merge: true});
            tg.HapticFeedback.impactOccurred('light');
        }

        betsRef.onSnapshot(snap => {
            if (isSpinning) return;
            const list = document.getElementById('players-list');
            list.innerHTML = '';
            let total = 0;
            const newPlayers = {};

            snap.forEach(d => {
                const p = d.data();
                const color = getColor(p.username);
                newPlayers[p.username] = { ...p, color: color };
                total += p.amount;

                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –ø–æ–¥–∞—Ä–∫–æ–≤
                let giftsHtml = '';
                if (p.stakedItems && p.stakedItems.length > 0) {
                    giftsHtml = '<div class="gift-stack">';
                    p.stakedItems.forEach(item => {
                        giftsHtml += `<img src="${item.image}" class="gift-fragment">`;
                    });
                    giftsHtml += '</div>';
                }

                list.innerHTML += `<div class="player-badge" style="border-color:${color}">
                    <img src="${p.photo}" class="w-4 h-4 rounded-full">
                    <span>${p.displayName}</span>
                    ${giftsHtml}
                    <span class="opacity-50 ml-1">${p.amount.toLocaleString()} MJ</span>
                </div>`;
                
                if (!imgObjects[p.photo]) { 
                    const img = new Image(); img.src = p.photo; img.onload = draw; imgObjects[p.photo] = img; 
                }
            });

            playersData = newPlayers;
            document.getElementById('total-bank').innerText = total.toLocaleString();
            const me = playersData[myUsername];
            document.getElementById('my-chance').innerText = me ? Math.round((me.amount / total) * 100) + "%" : "0%";
            
            if (Object.keys(newPlayers).length >= 2) {
                arenaRef.get().then(doc => { if (doc.exists && !doc.data().active) arenaRef.update({ active: true, endTime: Date.now() + 20000 }); });
            }
            draw();
        });

        arenaRef.onSnapshot(doc => {
            if (!doc.exists) { isProcessed = false; return; }
            const data = doc.data();
            document.getElementById('round-num').innerText = `–†–∞—É–Ω–¥ #${data.round}`;
            if (data.winner && !isSpinning && !isProcessed) { showResult(data.winner, data.totalBankAtEnd || 0); return; }
            
            clearInterval(timerInterval);
            if (!data.active) return;
            timerInterval = setInterval(() => {
                const diff = Math.max(0, Math.floor((data.endTime - Date.now()) / 1000));
                document.getElementById('timer-val').innerText = `00:${diff < 10 ? '0'+diff : diff}`;
                if (diff <= 0 && !isSpinning && !isProcessed) startFinalProcess();
            }, 1000);
        });

        async function startFinalProcess() {
            isSpinning = true;
            document.querySelectorAll('.bet-btn').forEach(b => b.disabled = true);
            const players = Object.values(playersData);
            if (players.length === 0) return;
            
            if (players[0].username === myUsername) {
                const total = players.reduce((s, p) => s + p.amount, 0);
                const rand = Math.random() * total;
                let current = 0, winner = players[0];
                for (let p of players) { current += p.amount; if (rand <= current) { winner = p; break; } }
                await arenaRef.update({ winner: winner.username, totalBankAtEnd: total, status: 'closed' });
            }
            runBallAnimation();
        }

        function runBallAnimation() {
            const ball = document.getElementById('ball');
            const arena = document.getElementById('arena-container');
            ball.style.display = 'block';
            let px = arena.offsetWidth/2, py = arena.offsetHeight/2;
            let vx = (Math.random()-0.5)*35, vy = (Math.random()-0.5)*35;
            const move = setInterval(() => {
                px += vx; py += vy;
                if (px<=0 || px>=arena.offsetWidth-18) { vx *= -1; }
                if (py<=0 || py>=arena.offsetHeight-18) { vy *= -1; }
                vx *= 0.99; vy *= 0.99;
                ball.style.left = px+'px'; ball.style.top = py+'px';
                if (Math.abs(vx) + Math.abs(vy) < 0.25) { 
                    clearInterval(move); 
                    arenaRef.get().then(snap => { if(snap.data().winner) showResult(snap.data().winner, snap.data().totalBankAtEnd); });
                }
            }, 16);
        }

        async function showResult(winnerId, totalBank) {
            if (isProcessed) return;
            isProcessed = true;
            
            const winner = playersData[winnerId] || { displayName: winnerId, photo: '' };
            const prize = Math.floor(totalBank * 0.95);
            
            document.getElementById('win-avatar').src = winner.photo;
            document.getElementById('win-name').innerText = winner.displayName;
            document.getElementById('win-prize').innerText = `${prize.toLocaleString()} MJ`;
            document.getElementById('win-modal').style.display = 'flex';

            const playersArr = Object.values(playersData);
            if (playersArr[0].username === myUsername) {
                try {
                    let allGifts = [];
                    playersArr.forEach(p => { if (p.stakedItems) allGifts = allGifts.concat(p.stakedItems); });

                    await db.collection("users").doc(winnerId).update({ balance: firebase.firestore.FieldValue.increment(prize) });

                    if (allGifts.length > 0) {
                        const batch = dbInv.batch();
                        allGifts.forEach(gift => {
                            const ref = dbInv.collection("users").doc(winnerId.toLowerCase()).collection("inventory").doc();
                            batch.set(ref, { name: gift.name, image: gift.image, dateAdded: Date.now() });
                        });
                        await batch.commit();
                    }

                    await db.collection("ice_arena_history").add({ 
                        winner: winnerId, displayName: winner.displayName, photo: winner.photo, bank: prize, date: Date.now() 
                    });
                    const bSnap = await betsRef.get();
                    const bch = db.batch();
                    bSnap.forEach(d => bch.delete(d.ref));
                    await bch.commit();
                    await arenaRef.delete();
                } catch (e) { console.error(e); }
            }
            setTimeout(() => location.reload(), 6000);
        }

        function draw() {
            const players = Object.values(playersData);
            const total = players.reduce((s, p) => s + p.amount, 0);
            ctx.clearRect(0,0,canvas.width,canvas.height);
            if (!total) return;
            let start = 0;
            const centerX = canvas.width/2, centerY = canvas.height/2;
            players.forEach(p => {
                const slice = (p.amount/total)*2*Math.PI;
                ctx.beginPath(); ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, canvas.width, start, start+slice);
                ctx.fillStyle = p.color; ctx.fill();
                const midAngle = start + slice/2;
                const dist = canvas.width * 0.3;
                const ax = centerX + Math.cos(midAngle) * dist, ay = centerY + Math.sin(midAngle) * dist;
                if (imgObjects[p.photo]) {
                    ctx.save(); ctx.beginPath(); ctx.arc(ax, ay, 27, 0, Math.PI*2); ctx.clip();
                    ctx.drawImage(imgObjects[p.photo], ax-25, ay-25, 50, 50); ctx.restore();
                }
                start += slice;
            });
        }
        tg.expand(); resize();
    </script>
</body>
</html>