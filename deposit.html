<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Депозит предметов</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; color: white; font-family: -apple-system, sans-serif; padding: 20px; overflow-x: hidden; }
        .inventory-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 120px; }
        .nft-card { background: linear-gradient(145deg, #111 0%, #050505 100%); border: 2px solid rgba(255, 255, 255, 0.08); border-radius: 24px; padding: 12px; text-align: center; position: relative; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .nft-card.selected { border-color: #3b82f6; background: linear-gradient(145deg, #0a192f 0%, #050505 100%); transform: scale(1.02); }
        .nft-image { width: 100%; aspect-ratio: 1/1; border-radius: 20px; object-fit: cover; margin-bottom: 8px; }
        .check-mark { position: absolute; top: 10px; right: 10px; background: #3b82f6; color: white; width: 24px; height: 24px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); z-index: 10; }
        .selected .check-mark { display: flex; }
        .deposit-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(20px); padding: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1); z-index: 100; }
        .btn-main { background: #3b82f6; color: white; width: 100%; padding: 16px; border-radius: 16px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        .btn-main:disabled { background: #222; color: #555; }
    </style>
</head>
<body>

    <div class="flex items-center mb-8 gap-4">
        <button onclick="location.href='ice.html'" class="text-zinc-400 text-3xl p-2 active:scale-75 transition-transform">←</button>
        <div class="flex-1">
            <h1 class="text-xl font-black italic tracking-tighter uppercase">Выберите подарки</h1>
        </div>
    </div>

    <div id="inventory-list" class="inventory-grid"></div>

    <div class="deposit-bar">
        <button id="deposit-btn" disabled class="btn-main" onclick="confirmDeposit()">
            Сделать ставку (0)
        </button>
    </div>

    <script>
        // КОНФИГ 1: Инвентарь (откуда берем)
        const inventoryApp = firebase.initializeApp({
            apiKey: "AIzaSyBUl6qHJRj8wI_L_1p9CETHpsjus99vVMg",
            authDomain: "majorinventory-df164.firebaseapp.com",
            projectId: "majorinventory-df164",
            storageBucket: "majorinventory-df164.firebasestorage.app",
            appId: "1:603741122650:web:35e730ab0448331eb3e863"
        }, "inventoryApp");

        // КОНФИГ 2: Арена (куда ставим)
        const arenaApp = firebase.initializeApp({
            apiKey: "AIzaSyC48y52WCHeVqF8GB_YXHY-xGyCH3frhHU",
            authDomain: "majorcrypto-28e9a.firebaseapp.com",
            projectId: "majorcrypto-28e9a",
            storageBucket: "majorcrypto-28e9a.firebasestorage.app",
            appId: "1:16272287356:web:2b5c9bafc7bfd85ef60bf9"
        }, "arenaApp");

        const dbInv = inventoryApp.firestore();
        const dbArena = arenaApp.firestore();
        const tg = window.Telegram.WebApp;
        
        const user = tg.initDataUnsafe?.user;
        const myUsername = (user?.username || `id${user?.id}` || "guest").toLowerCase();

        // Цены в MJ (при необходимости добавьте другие предметы сюда)
        const prices = { 
            "Scared Cat": 375000, 
            "Vintage Cigar": 150000 
        };
        
        let selectedItems = [];

        function loadInventory() {
            dbInv.collection("users").doc(myUsername).collection("inventory")
            .onSnapshot((snap) => {
                const list = document.getElementById('inventory-list');
                list.innerHTML = '';
                if(snap.empty) {
                    list.innerHTML = '<div class="col-span-2 text-center text-zinc-500 py-10">У вас нет подарков</div>';
                    return;
                }
                snap.forEach((doc) => {
                    const item = doc.data();
                    const price = prices[item.name] || 10000;
                    const card = document.createElement('div');
                    card.className = 'nft-card';
                    card.id = `card-${doc.id}`;
                    card.onclick = () => toggleSelect(doc.id, item, price);
                    card.innerHTML = `
                        <div class="check-mark">✓</div>
                        <img src="${item.image}" class="nft-image">
                        <div class="text-[10px] font-bold uppercase truncate">${item.name}</div>
                        <div class="text-blue-500 text-[10px] font-black">${price.toLocaleString()} MJ</div>
                    `;
                    list.appendChild(card);
                });
            });
        }

        function toggleSelect(id, data, price) {
            const card = document.getElementById(`card-${id}`);
            const idx = selectedItems.findIndex(i => i.id === id);
            if (idx > -1) {
                selectedItems.splice(idx, 1);
                card.classList.remove('selected');
            } else {
                selectedItems.push({id, ...data, price});
                card.classList.add('selected');
            }
            const totalMJ = selectedItems.reduce((s, i) => s + i.price, 0);
            document.getElementById('deposit-btn').disabled = selectedItems.length === 0;
            document.getElementById('deposit-btn').innerText = `СТАВКА: ${totalMJ.toLocaleString()} MJ (${selectedItems.length})`;
            if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        }

        async function confirmDeposit() {
            const totalMJ = selectedItems.reduce((s, i) => s + i.price, 0);
            
            // Запрашиваем подтверждение через Telegram UI или обычный confirm
            if (!confirm(`Вы ставите ${selectedItems.length} подарков на сумму ${totalMJ.toLocaleString()} MJ?`)) return;

            const btn = document.getElementById('deposit-btn');
            btn.disabled = true;
            btn.innerText = "ОТПРАВКА...";

            try {
                // 1. Создаем запись о ставке в базе АРЕНЫ
                // stakedItems сохраняется в массив объектов для корректного отображения иконок
                await dbArena.collection("ice_arena_bets").doc(myUsername).set({
                    username: myUsername,
                    displayName: user?.first_name || myUsername,
                    photo: user?.photo_url || `https://t.me/i/userpic/320/${myUsername}.jpg`,
                    amount: firebase.firestore.FieldValue.increment(totalMJ),
                    isNft: true,
                    stakedItems: selectedItems.map(i => ({
                        name: i.name, 
                        image: i.image
                    })) 
                }, {merge: true});

                // 2. Удаляем из базы ИНВЕНТАРЯ (Batch транзакция)
                const batch = dbInv.batch();
                selectedItems.forEach(item => {
                    const docRef = dbInv.collection("users").doc(myUsername).collection("inventory").doc(item.id);
                    batch.delete(docRef);
                });
                await batch.commit();

                // 3. Уведомление и ПЕРЕХОД НА ICE.HTML
                if(tg.showAlert) {
                    tg.showAlert("Успешно! Предметы на кону.", () => {
                        location.href = 'ice.html';
                    });
                } else {
                    alert("Успешно!");
                    location.href = 'ice.html';
                }

            } catch (e) {
                console.error(e);
                alert("Ошибка при депозите: " + e.message);
                btn.disabled = false;
                btn.innerText = "ПОПРОБОВАТЬ СНОВА";
            }
        }

        tg.expand();
        loadInventory();
    </script>
</body>
</html>