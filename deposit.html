<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Депозит предметов</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #000;
            color: white;
            font-family: -apple-system, sans-serif;
            padding: 20px;
            overflow-x: hidden;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 100px; /* Место для кнопки внизу */
        }

        .nft-card {
            background: linear-gradient(145deg, #111 0%, #050505 100%);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            padding: 12px;
            text-align: center;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Состояние когда предмет выбран */
        .nft-card.selected {
            border-color: #3b82f6;
            background: linear-gradient(145deg, #0a192f 0%, #050505 100%);
            transform: scale(1.02);
        }

        .nft-image {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 20px;
            object-fit: cover;
            margin-bottom: 8px;
        }

        /* Галочка */
        .check-mark {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #3b82f6;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            z-index: 10;
        }

        .selected .check-mark {
            display: flex;
        }

        .deposit-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        .btn-main {
            background: #3b82f6;
            color: white;
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }

        .btn-main:disabled {
            background: #222;
            color: #555;
        }
    </style>
</head>
<body>

    <div class="flex items-center mb-8 gap-4">
        <button onclick="history.back()" class="text-zinc-400 text-3xl p-2 active:scale-75 transition-transform leading-none">←</button>
        <div class="flex-1">
            <h1 class="text-xl font-black italic tracking-tighter uppercase">Выберите подарки</h1>
        </div>
    </div>

    <div id="inventory-list" class="inventory-grid">
        </div>

    <div class="deposit-bar">
        <button id="deposit-btn" disabled class="btn-main" onclick="confirmDeposit()">
            Сделать ставку (0)
        </button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBUl6qHJRj8wI_L_1p9CETHpsjus99vVMg",
            authDomain: "majorinventory-df164.firebaseapp.com",
            projectId: "majorinventory-df164",
            storageBucket: "majorinventory-df164.firebasestorage.app",
            messagingSenderId: "603741122650",
            appId: "1:603741122650:web:35e730ab0448331eb3e863",
            measurementId: "G-7GS1M09F4T"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;
        
        const user = tg.initDataUnsafe?.user;
        const myUsername = (user?.username || `id${user?.id}` || "guest").toLowerCase();

        let selectedItems = [];

        function loadInventory() {
            db.collection("users").doc(myUsername).collection("inventory")
            .onSnapshot((querySnapshot) => {
                const list = document.getElementById('inventory-list');
                list.innerHTML = '';

                querySnapshot.forEach((doc) => {
                    const item = doc.data();
                    const itemId = doc.id;
                    
                    const card = document.createElement('div');
                    card.className = 'nft-card';
                    card.id = `card-${itemId}`;
                    card.onclick = () => toggleSelect(itemId, item);
                    
                    card.innerHTML = `
                        <div class="check-mark">✓</div>
                        <img src="${item.image}" class="nft-image">
                        <div class="text-[10px] text-zinc-400 font-bold uppercase truncate">${item.name}</div>
                    `;
                    list.appendChild(card);
                });
            });
        }

        function toggleSelect(id, data) {
            const card = document.getElementById(`card-${id}`);
            const index = selectedItems.findIndex(i => i.id === id);

            if (index > -1) {
                selectedItems.splice(index, 1);
                card.classList.remove('selected');
            } else {
                selectedItems.push({id, ...data});
                card.classList.add('selected');
            }

            updateButton();
            if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        }

        function updateButton() {
            const btn = document.getElementById('deposit-btn');
            btn.disabled = selectedItems.length === 0;
            btn.innerText = `Сделать ставку (${selectedItems.length})`;
        }

        async function confirmDeposit() {
            if (confirm(`Вы уверены, что хотите поставить ${selectedItems.length} предметов?`)) {
                // Здесь будет логика переноса в общую базу ставок
                tg.showScanQrPopup({ text: "Обработка ставки..." });
                
                // Пример: удаление из инвентаря (имитация ставки)
                for (let item of selectedItems) {
                    await db.collection("users").doc(myUsername).collection("inventory").doc(item.id).delete();
                }
                
                tg.closeScanQrPopup();
                alert("Ставка принята! Предметы отправлены в игру.");
                location.href = 'cases.html';
            }
        }

        tg.expand();
        loadInventory();
    </script>
</body>
</html>