<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Firebase Initializer</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body style="background: #000; color: #3b82f6; font-family: sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; text-align: center;">

    <div>
        <h2 id="status">Инициализация базы...</h2>
        <p id="log" style="color: #666; font-size: 12px;"></p>
    </div>

    <script>
        // Твой конфиг
        const firebaseConfig = {
            apiKey: "AIzaSyC48y52WCHeVqF8GB_YXHY-xGyCH3frhHU",
            authDomain: "majorcrypto-28e9a.firebaseapp.com",
            projectId: "majorcrypto-28e9a",
            storageBucket: "majorcrypto-28e9a.firebasestorage.app",
            messagingSenderId: "16272287356",
            appId: "1:16272287356:web:2b5c9bafc7bfd85ef60bf9",
            measurementId: "G-033CMJ0J70",
            databaseURL: "https://majorcrypto-28e9a-default-rtdb.firebaseio.com/"
        };

        // Инициализация
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;
        const log = document.getElementById('log');
        const status = document.getElementById('status');

        async function initFirebase() {
            const user = tg.initDataUnsafe?.user;
            
            if (!user) {
                status.innerText = "Ошибка: Открой через Telegram";
                return;
            }

            const username = user.username ? user.username.toLowerCase() : `id${user.id}`;
            log.innerText = `Проверка пользователя: ${username}...`;

            try {
                // 1. Создаем таблицу users и первого юзера
                await db.collection("users").doc(username).set({
                    balance: 100, // Даем 100 MJ для теста
                    first_name: user.first_name,
                    last_name: user.last_name || "",
                    user_id: user.id,
                    username: username,
                    role: "admin",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                log.innerText += "\nКоллекция 'users' готова.";

                // 2. Создаем таблицу transfers (пустая запись для инициализации структуры)
                await db.collection("transfers").add({
                    from: "system",
                    to: username,
                    amount: 100,
                    description: "Initial Balance",
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                log.innerText += "\nКоллекция 'transfers' готова.";
                status.innerText = "✅ База настроена!";
                status.style.color = "#4ade80";

                // Через 2 секунды можно закрывать или переходить
                setTimeout(() => { tg.close(); }, 3000);

            } catch (e) {
                status.innerText = "Ошибка доступа!";
                log.innerText = e.message;
                console.error(e);
            }
        }

        initFirebase();
    </script>
</body>
</html>