<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MJ Roulette</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background-color: #000; color: white; 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            overflow-x: hidden; padding-bottom: 110px;
        }
        .nav-blur {
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        .roulette-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            /* background: radial-gradient(circle at center, rgba(30, 30, 30, 0.8) 0%, rgba(10, 10, 10, 0.8) 100%); */
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(255, 255, 255, 0.05);
        }
        .prize-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            z-index: 10;
        }
        .participant-item {
            position: absolute;
            transform-origin: 150px; /* –¶–µ–Ω—Ç—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
        }
        .participant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .participant-name {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 0.7rem;
            color: #ccc;
            opacity: 0.8;
            margin-top: 4px;
        }
        .join-button {
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
            transition: all 0.2s ease;
        }
        .join-button:disabled {
            background: #1a1a1a;
            color: #444;
            box-shadow: none;
            cursor: not-allowed;
        }
        .winner-animation {
            animation: pulse-winner 1.5s infinite alternate;
        }
        @keyframes pulse-winner {
            from { transform: scale(1); box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
            to { transform: scale(1.05); box-shadow: 0 0 20px rgba(59, 130, 246, 0.8); }
        }
    </style>
</head>
<body class="p-6">

    <div class="flex items-center gap-4 mb-8">
        <button onclick="history.back()" class="w-10 h-10 flex items-center justify-center bg-zinc-900 rounded-full active:scale-90 transition-transform">
            <span class="text-xl">‚Üê</span>
        </button>
        <h1 class="text-xl font-bold tracking-tight text-blue-500">MJ –†—É–ª–µ—Ç–∫–∞</h1>
    </div>

    <div class="text-center mb-8">
        <p class="text-zinc-400 text-sm mb-2">–†–æ–∑—ã–≥—Ä—ã—à –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è —á–µ—Ä–µ–∑:</p>
        <div id="countdown" class="text-3xl font-black italic text-white">00–¥ 00—á 00–º 00—Å</div>
    </div>

    <div class="roulette-container mb-8">
        <img id="prize-nft" src="https://nft.fragment.com/gift/vintagecigar-7301.large.jpg" class="prize-image" alt="NFT Prize">
        <div id="participants-circle"></div>
    </div>

    <div class="text-center mb-6">
        <button id="join-roulette-btn" class="join-button w-full py-4 rounded-xl font-black uppercase text-sm">
            –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å!
        </button>
        <p id="participant-count" class="text-zinc-500 text-xs mt-3">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: 0</p>
    </div>

    <div id="winner-display" class="hidden text-center p-4 bg-zinc-900/50 border border-blue-500/30 rounded-2xl">
        <p class="text-zinc-400 text-sm mb-2">–ü–û–ë–ï–î–ò–¢–ï–õ–¨!</p>
        <div class="flex items-center justify-center gap-3">
            <img id="winner-avatar" src="" class="w-12 h-12 rounded-full border-2 border-blue-500 winner-animation" alt="Winner Avatar">
            <span id="winner-name" class="text-xl font-black italic text-blue-400">@personovich</span>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 h-20 nav-blur flex justify-around items-center px-8 z-50">
        <a href="index.html" class="flex flex-col items-center gap-1 opacity-40">
            <span class="text-2xl">üè†</span>
            <span class="text-[10px] font-medium uppercase tracking-widest text-zinc-400">–ì–ª–∞–≤–Ω–∞—è</span>
        </a>
        <a href="cases.html" class="flex flex-col items-center gap-1 opacity-40">
            <span class="text-2xl">üì¶</span>
            <span class="text-[10px] font-medium uppercase tracking-widest text-zinc-400">–ö–µ–π—Å—ã</span>
        </a>
        <a href="profile.html" class="flex flex-col items-center gap-1 opacity-40">
            <span class="text-2xl">üë§</span>
            <span class="text-[10px] font-medium uppercase tracking-widest text-zinc-400">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </a>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const user = tg.initDataUnsafe?.user;
        const prizeImageUrl = "https://nft.fragment.com/gift/vintagecigar-7301.large.jpg";
        const winnerUsername = "personovich"; // –í–∞—à –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å
        const raffleDurationMs = 3 * 24 * 60 * 60 * 1000; // 3 –¥–Ω—è –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
        let raffleEndTime;

        // –≠–º—É–ª—è—Ü–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
        let participants = JSON.parse(localStorage.getItem('roulette_participants')) || [];

        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–µ—Ä–∞
        function initRaffleTimer() {
            let storedStartTime = localStorage.getItem('roulette_start_time');
            if (!storedStartTime) {
                storedStartTime = Date.now();
                localStorage.setItem('roulette_start_time', storedStartTime);
            }
            raffleEndTime = parseInt(storedStartTime) + raffleDurationMs;

            updateCountdown();
            const timerInterval = setInterval(updateCountdown, 1000);
        }

        function updateCountdown() {
            const now = Date.now();
            const timeLeft = raffleEndTime - now;

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                document.getElementById('countdown').innerText = "–ó–ê–í–ï–†–®–ï–ù–û!";
                showWinner();
            } else {
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                document.getElementById('countdown').innerText = 
                    `${String(days).padStart(2, '0')}–¥ ${String(hours).padStart(2, '0')}—á ${String(minutes).padStart(2, '0')}–º ${String(seconds).padStart(2, '0')}—Å`;
            }
            updateJoinButtonState();
        }

        // 2. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        function renderParticipants() {
            const participantsCircle = document.getElementById('participants-circle');
            participantsCircle.innerHTML = '';
            document.getElementById('participant-count').innerText = `–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${participants.length}`;

            const radius = 120; // –†–∞–¥–∏—É—Å, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Ä–∞—Å–ø–æ–ª–∞–≥–∞—é—Ç—Å—è –∞–≤–∞—Ç–∞—Ä–∫–∏
            const totalParticipants = participants.length;

            participants.forEach((p, index) => {
                const angle = (index / totalParticipants) * 2 * Math.PI;
                const x = radius * Math.cos(angle);
                const y = radius * Math.sin(angle);

                const participantDiv = document.createElement('div');
                participantDiv.className = 'participant-item absolute flex flex-col items-center';
                participantDiv.style.left = `calc(50% + ${x}px - 20px)`; /* 20px = –ø–æ–ª–æ–≤–∏–Ω–∞ —à–∏—Ä–∏–Ω—ã –∞–≤–∞—Ç–∞—Ä–∫–∏ */
                participantDiv.style.top = `calc(50% + ${y}px - 20px)`;  /* 20px = –ø–æ–ª–æ–≤–∏–Ω–∞ –≤—ã—Å–æ—Ç—ã –∞–≤–∞—Ç–∞—Ä–∫–∏ */
                participantDiv.style.transform = `rotate(${angle * 180 / Math.PI + 90}deg)`; /* –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –∫ —Ü–µ–Ω—Ç—Ä—É */

                const avatarImg = document.createElement('img');
                avatarImg.className = 'participant-avatar';
                avatarImg.src = p.avatar_url || `https://t.me/i/userpic/320/${p.username || 'default'}.jpg`;
                avatarImg.alt = p.username;

                const nameSpan = document.createElement('span');
                nameSpan.className = 'participant-name';
                nameSpan.innerText = `@${p.username}`;
                nameSpan.style.transform = `rotate(-${angle * 180 / Math.PI + 90}deg)`; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –≤ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ

                participantDiv.appendChild(avatarImg);
                participantDiv.appendChild(nameSpan);
                participantsCircle.appendChild(participantDiv);
            });
        }

        // 3. –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ "–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å"
        const joinButton = document.getElementById('join-roulette-btn');
        joinButton.addEventListener('click', () => {
            if (!user) {
                tg.showAlert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ Telegram.");
                return;
            }
            const myUsername = user.username.toLowerCase();
            const alreadyJoined = participants.some(p => p.username.toLowerCase() === myUsername);

            if (alreadyJoined) {
                tg.showAlert("–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —ç—Ç–æ–º —Ä–æ–∑—ã–≥—Ä—ã—à–µ!");
            } else {
                participants.push({
                    username: user.username,
                    first_name: user.first_name,
                    avatar_url: user.photo_url
                });
                localStorage.setItem('roulette_participants', JSON.stringify(participants));
                renderParticipants();
                tg.HapticFeedback.notificationOccurred('success');
                tg.showNotification({
                    type: 'success',
                    message: "–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å!"
                });
                updateJoinButtonState();
            }
        });

        function updateJoinButtonState() {
            if (!user) {
                joinButton.disabled = true;
                joinButton.innerText = "–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ Telegram";
                return;
            }

            const now = Date.now();
            if (now >= raffleEndTime) {
                joinButton.disabled = true;
                joinButton.innerText = "–†–æ–∑—ã–≥—Ä—ã—à –∑–∞–≤–µ—Ä—à–µ–Ω";
                return;
            }

            const myUsername = user.username.toLowerCase();
            const alreadyJoined = participants.some(p => p.username.toLowerCase() === myUsername);

            if (alreadyJoined) {
                joinButton.disabled = true;
                joinButton.innerText = "–í—ã —É—á–∞—Å—Ç–≤—É–µ—Ç–µ";
            } else {
                joinButton.disabled = false;
                joinButton.innerText = "–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å!";
            }
        }

        // 4. –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
        function showWinner() {
            document.getElementById('join-roulette-btn').classList.add('hidden');
            document.getElementById('participant-count').classList.add('hidden');
            document.getElementById('countdown').classList.add('hidden');

            const winnerDisplay = document.getElementById('winner-display');
            winnerDisplay.classList.remove('hidden');

            const winnerAvatarUrl = `https://t.me/i/userpic/320/${winnerUsername}.jpg`;
            document.getElementById('winner-avatar').src = winnerAvatarUrl;
            document.getElementById('winner-name').innerText = `@${winnerUsername}`;
        }

        // –ó–∞–ø—É—Å–∫
        initRaffleTimer();
        renderParticipants();
        tg.expand();
    </script>
</body>
</html>